rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if the user is the specific admin
    function isAdmin() {
      return request.auth != null && request.auth.token.email == 'kazuki2kr@gmail.com';
    }

    // ==========================================
    // Fantasy Quizzes Kingdom Game Rules
    // ==========================================

    // クイズ問題管理 (Global Questions)
    match /questions/{questionId} {
      allow read: if true; // 誰でも読み取り可能（ゲーム開始に必須）
      allow write: if isAdmin(); // 編集は管理者のみ
    }

    // ランキング (Global Leaderboard)
    match /leaderboard/{scoreId} {
      allow read: if true;
      allow create: if true; // 匿名ユーザーも含めてスコア登録許可
    }

    // ゲームルーム (Rooms)
    match /rooms/{roomId} {
      allow read: if true; // ルーム情報の読み取りは誰でもOK
      allow create: if request.auth != null; // ルーム作成は認証必須
      allow update: if request.auth != null; // 状態更新など

      // ルーム内のプレイヤー (Players Subcollection)
      match /players/{userId} {
        allow read: if true;
        allow write: if request.auth != null; // 参加登録、スコア更新など
      }

      // ルーム内の問題 (Questions Subcollection)
      match /questions/{questionId} {
        allow read: if true;
        allow write: if request.auth != null; // ホストによる問題追加
      }
    }

    // ==========================================
    // Portal / Blog Feature Rules (Existing)
    // ==========================================
    
    // 記事の統計データ
    match /posts_stats/{slug} {
      allow read: if true; 
      allow write: if true; 
      
      match /comments/{commentId} {
        allow read: if true; 
        allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
        allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
      }
    }
  }
}
